// Erosko.cz - Escort Portal Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum ProfileType {
  SOLO // Independent escort
  PRIVAT // Private location (Erotick√Ω priv√°t)
  MASSAGE_SALON // Massage salon (Erotick√© mas√°≈æe)
  ESCORT_AGENCY // Escort agency (Escort Agentura)
  DIGITAL_AGENCY // Online services (Digit√°ln√≠ Agentura)
  SWINGERS_CLUB // Swingers club (Swingers klub)
  NIGHT_CLUB // Night club (Night Club)
  STRIP_CLUB // Strip club (Strip Club)
}

enum Category {
  HOLKY_NA_SEX // Girls for sex
  EROTICKE_MASERKY // Erotic masseuses
  DOMINA // BDSM/Domina
  DIGITALNI_SLUZBY // Digital services (webcam, phone sex, etc.)
  EROTICKE_PODNIKY // Erotic businesses (clubs, etc.)
}

enum UserRole {
  USER
  PROVIDER
  ADMIN
}

enum ServiceCategory {
  PRAKTIKY // Praktiky pro holky na sex
  DRUHY_MASAZI // Druhy mas√°≈æ√≠ pro mas√©rky
  EXTRA_SLUZBY // Extra slu≈æby pro mas√©rky
  BDSM_PRAKTIKY // BDSM praktiky
  ONLINE_SLUZBY // Online/digit√°ln√≠ slu≈æby
}

enum PageType {
  CATEGORY // Category pages (/holky-na-sex, /eroticke-masaze)
  CITY // City pages (/praha, /brno)
  CATEGORY_CITY // Category + City (/holky-na-sex/praha)
  CUSTOM // Custom landing pages
}

// Models
model User {
  id            String   @id @default(cuid())
  phone         String   @unique // Primary login method
  email         String?  @unique // Optional for notifications, unique for email login
  passwordHash  String
  phoneVerified Boolean  @default(false)
  emailVerified Boolean  @default(false) // ‚ûï NEW: Email verification status
  role          UserRole @default(USER)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  profiles              Profile[]
  businesses            Business[]
  reviews               Review[]
  favorites             Favorite[]
  requestedChanges      PendingChange[]    @relation("RequestedChanges")
  reviewedChanges       PendingChange[]    @relation("ReviewedChanges")
  verificationCodes     VerificationCode[]
  verifiedVerifications Verification[]     @relation("VerifiedVerifications") // ‚ûï NEW
  searchQueries         SearchQuery[]      // ‚ûï NEW

  @@index([phone])
}

// SMS Verification codes for password reset and phone verification
model VerificationCode {
  id        String               @id @default(cuid())
  phone     String
  code      String // 6-digit code
  type      VerificationCodeType
  expiresAt DateTime
  verified  Boolean              @default(false)
  createdAt DateTime             @default(now())

  // Relations
  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([code])
}

enum VerificationCodeType {
  PHONE_VERIFICATION
  PASSWORD_RESET
}

// ‚ûï NEW ENUMS for Multi-Tier Verification
enum VerificationType {
  PHONE        // ‚úÖ SMS verification (automatic)
  PHOTO        // üì∏ Selfie with paper "Erosko.cz + date"
  VIDEO        // üé• 10-second verification video
  ID_DOCUMENT  // üÜî Passport/ID card scan
}

enum VerificationStatus {
  PENDING   // Waiting for admin review
  APPROVED  // Verified by admin
  REJECTED  // Rejected with reason
  EXPIRED   // Verification expired (photo/video only)
}

model Business {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  domain      String?     // Optional: erosko.cz or nhescort.com
  description String?
  phone       String
  email       String?
  website     String?
  address     String?
  city        String
  profileType ProfileType

  // Business-specific fields
  equipment    Json? // Array of equipment/amenities
  openingHours Json? // Opening hours by day: { monday: "9:00-22:00", ... }

  // Metadata
  approved  Boolean @default(false) // Admin approved for public display
  verified  Boolean @default(false) // Admin verified with badge
  isNew     Boolean @default(true)
  isPopular Boolean @default(false)

  // Stats
  rating      Float @default(0)
  reviewCount Int   @default(0)
  viewCount   Int   @default(0)

  // SEO Fields (AI-generated)
  seoTitle          String?
  seoDescription    String?
  seoKeywords       String?
  seoQualityScore   Int?
  ogImageUrl        String?
  seoManualOverride Boolean   @default(false)
  seoLastGenerated  DateTime?

  // Advanced SEO Fields
  focusKeyword      String?
  secondaryKeywords String?   @default("")
  seoScore          Int?      @default(0)
  schemaMarkup      String? // JSON stringified
  lastAnalyzed      DateTime?
  contentScore      Int?      @default(0)
  readabilityScore  Int?      @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerId        String
  owner          User            @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  profiles       Profile[]
  photos         Photo[]
  reviews        Review[]
  pendingChanges PendingChange[]
  verifications  Verification[]  // ‚ûï NEW: Multi-tier verification badges

  @@index([city])
  @@index([profileType])
  @@index([slug])
  @@index([approved])
  @@index([verified])
  @@index([approved, verified])
  @@index([ownerId])
  @@index([rating])
  @@index([viewCount])
  @@index([createdAt])
  @@index([domain])
}

model Profile {
  id          String  @id @default(cuid())
  name        String
  slug        String  @unique
  domain      String? // Optional: erosko.cz or nhescort.com
  age         Int
  description String?
  phone       String
  email       String?

  // Location
  city     String
  address  String?
  location String // Display location

  // Profile type
  profileType ProfileType
  category    Category

  // Physical attributes
  height      Int? // cm
  weight      Int? // kg
  bust        String? // 1, 2, 3, 4
  waist       Int? // cm
  hips        Int? // cm
  hairColor   String? // blonde, brunette, black, red, other
  hairLength  String? // short, medium, long
  eyeColor    String? // blue, green, brown, hazel, other
  breastType  String? // natural, silicone
  bodyType    String? // slim, athletic, curvy, plus-size
  ageCategory String? // 18-25, 26-35, 36-45, 46+
  pubicHair   String? // shaved, trimmed, natural

  // Additional attributes
  role        String? // active, passive, switch, dominant, submissive
  nationality String? // czech, slovak, polish, ukrainian, russian, etc.
  languages   String? // JSON array of languages
  orientation String? // hetero, bi, lesbian, gay
  tattoos     String? // none, small, medium, large
  piercing    String? // none, ears, multiple

  // Services
  offersEscort Boolean @default(false)
  travels      Boolean @default(false)

  // Opening hours (for individual profiles)
  openingHours Json? // Opening hours by day: { monday: "9:00-22:00", ... }

  // Private contacts (ADMIN ONLY - NOT displayed publicly)
  privateContacts Json? // { phone, whatsapp, email, telegram } - internal contacts

  // Metadata
  approved  Boolean @default(false) // Admin approved for public display
  verified  Boolean @default(false) // Admin verified with badge
  isNew     Boolean @default(true)
  isPopular Boolean @default(false)
  isOnline  Boolean @default(false)

  // Stats
  rating      Float @default(0)
  reviewCount Int   @default(0)
  viewCount   Int   @default(0)

  // SEO Fields (AI-generated)
  seoTitle        String?
  seoDescription  String?
  seoDescriptionA String? // Variant A (emotional)
  seoDescriptionB String? // Variant B (factual)
  seoDescriptionC String? // Variant C (benefits)
  seoKeywords     String?
  seoQualityScore Int?
  ogImageUrl      String?

  // SEO Master Override
  seoManualOverride Boolean   @default(false)
  seoLastGenerated  DateTime?
  seoLastReviewed   DateTime?

  // A/B Testing
  seoActiveVariant String @default("A")
  seoVariantStats  Json? // { A: {clicks: 77, impressions: 1240}, B: {...}, C: {...} }

  // Advanced SEO Fields
  focusKeyword      String?
  secondaryKeywords String?   @default("")
  seoScore          Int?      @default(0)
  schemaMarkup      String? // JSON stringified
  lastAnalyzed      DateTime?
  contentScore      Int?      @default(0)
  readabilityScore  Int?      @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  ownerId        String
  owner          User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  businessId     String?
  business       Business?        @relation(fields: [businessId], references: [id], onDelete: SetNull)
  photos         Photo[]
  reviews        Review[]
  services       ProfileService[]
  favorites      Favorite[]
  pendingChanges PendingChange[]
  verifications  Verification[]   // ‚ûï NEW: Multi-tier verification badges
  searchTags     ProfileSearchTag[] // Obl√≠ben√© vyhled√°v√°n√≠ tags

  @@index([city])
  @@index([category])
  @@index([profileType])
  @@index([slug])
  @@index([approved])
  @@index([verified])
  @@index([approved, verified])
  @@index([ownerId])
  @@index([rating])
  @@index([viewCount])
  @@index([createdAt])
  @@index([domain])
}

model Photo {
  id              String  @id @default(cuid())
  url             String
  alt             String?
  altQualityScore Int? // AI quality score 0-100
  order           Int     @default(0)
  isMain          Boolean @default(false)

  // Relations
  profileId  String?
  profile    Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([profileId])
  @@index([businessId])
}

model Service {
  id          String          @id @default(cuid())
  name        String          @unique
  description String?
  icon        String? // Icon name from lucide-react
  category    ServiceCategory @default(PRAKTIKY)

  // Relations
  profiles ProfileService[]
}

model ProfileService {
  id String @id @default(cuid())

  // Relations
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([profileId, serviceId])
  @@index([profileId])
  @@index([serviceId])
}

model Review {
  id            String    @id @default(cuid())
  rating        Int // 1-5
  comment       String?
  authorName    String? // For non-registered users / AI reviews
  isAIGenerated Boolean   @default(false) // Mark AI-generated reviews

  // Relations (authorId now optional for AI reviews)
  authorId   String?
  author     User?     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  profileId  String?
  profile    Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([businessId])
  @@index([authorId])
  @@index([rating])
}

model Favorite {
  id String @id @default(cuid())

  // Relations
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  profileId String
  profile   Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, profileId])
  @@index([userId])
  @@index([profileId])
}

enum ChangeStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ChangeType {
  PROFILE_UPDATE
  PHOTO_UPDATE
  BUSINESS_UPDATE
}

model PendingChange {
  id     String       @id @default(cuid())
  type   ChangeType
  status ChangeStatus @default(PENDING)

  // Reference to what's being changed
  profileId  String?
  profile    Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId String?
  business   Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Change data
  oldData Json? // Original data
  newData Json // Requested changes

  // Who requested the change
  requestedById String
  requestedBy   User   @relation("RequestedChanges", fields: [requestedById], references: [id], onDelete: Cascade)

  // Who approved/rejected
  reviewedById String?
  reviewedBy   User?     @relation("ReviewedChanges", fields: [reviewedById], references: [id])
  reviewedAt   DateTime?
  reviewNotes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([profileId])
  @@index([businessId])
  @@index([status])
  @@index([requestedById])
}

// Static Pages for Landing Pages & SEO
model StaticPage {
  id     String   @id @default(cuid())
  path   String   @unique // URL path (e.g., "/holky-na-sex", "/praha")
  domain String?  // Optional: erosko.cz or nhescort.com
  type   PageType @default(CUSTOM)

  // SEO Fields
  seoTitle       String
  seoDescription String
  h1             String
  content        String? @default("") // SEO text content
  keywords       String?
  ogImageUrl     String?

  // Advanced SEO Fields
  focusKeyword      String?
  secondaryKeywords String?   @default("")
  seoScore          Int?      @default(0)
  schemaMarkup      String? // JSON stringified
  lastAnalyzed      DateTime?
  contentScore      Int?      @default(0)
  readabilityScore  Int?      @default(0)

  // Metadata
  published Boolean @default(true)
  viewCount Int     @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([path])
  @@index([type])
  @@index([published])
  @@index([domain])
}

// Redirect Management
model Redirect {
  id        String   @id @default(cuid())
  from      String   @unique
  to        String
  type      Int      @default(301) // 301, 302, 307
  hits      Int      @default(0)
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([from])
  @@index([enabled])
}

// ‚ûï NEW: Multi-Tier Verification System
model Verification {
  id           String             @id @default(cuid())
  type         VerificationType
  status       VerificationStatus @default(PENDING)

  // Evidence
  documentUrl  String? // URL to uploaded photo/video/ID scan
  notes        String? // Admin notes during review

  // Relations
  profileId    String?
  profile      Profile?  @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessId   String?
  business     Business? @relation(fields: [businessId], references: [id], onDelete: Cascade)

  // Who verified it
  verifiedById String?
  verifiedBy   User?     @relation("VerifiedVerifications", fields: [verifiedById], references: [id])
  verifiedAt   DateTime?

  // Metadata
  expiresAt       DateTime? // For photo/video verifications (expire after 6 months)
  rejectionReason String?

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([profileId])
  @@index([businessId])
  @@index([status])
  @@index([type])
}

// ‚ûï NEW: Search Query Tracking
model SearchQuery {
  id          String   @id @default(cuid())
  query       String   // Raw search query (e.g., "escort praha")
  filters     String? // Applied filters JSON: { city: "Praha", service: "tantric" }

  // User tracking
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  // Metadata
  resultCount      Int      // How many results were shown
  clickedProfileId String? // If user clicked on a profile
  sessionId        String?  // Anonymous session tracking

  // Analytics
  deviceType  String? // "mobile", "desktop", "tablet"
  referrer    String? // Where did user come from

  createdAt   DateTime @default(now())

  @@index([query])
  @@index([userId])
  @@index([createdAt])
}

// ‚ûï NEW: Popular Searches (Dynamic)
model PopularSearch {
  id           String   @id @default(cuid())
  keyword      String   @unique     // Normalized keyword (e.g., "escort-praha")
  displayText  String               // User-friendly text (e.g., "Escort Praha")

  // Categorization
  category     String?              // "city", "service", "city-service", "custom"
  city         String?              // For filtering by location
  serviceType  String?              // For filtering by service

  // Stats
  searchCount  Int      @default(0) // Total searches in last 30 days
  clickCount   Int      @default(0) // How many times users clicked it
  lastSearched DateTime @default(now())

  // Admin control
  isPinned     Boolean  @default(false) // Admin can pin important searches
  isActive     Boolean  @default(true)  // Hide inactive searches
  order        Int      @default(0)     // Manual ordering (pinned first, then by searchCount)

  // SEO
  linkedPageUrl String? // Link to landing page (e.g., "/holky-na-sex/praha")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([searchCount])
  @@index([lastSearched])
  @@index([isPinned])
  @@index([category])
}

// Content Management System - Editable Blocks
model ContentBlock {
  id          String          @id @default(cuid())
  identifier  String          @unique // e.g., "hero_title", "hero_subtitle", "trust_stats"
  type        ContentBlockType
  title       String? // For admin panel display

  // Content fields
  content     String? // Text or HTML content
  data        String? // JSON stringified for complex data (arrays, objects)

  // Metadata
  page        String          @default("homepage") // "homepage", "about", "contact", etc.
  section     String?         // "hero", "features", "testimonials", etc.
  published   Boolean         @default(true)
  order       Int             @default(0) // For ordering blocks within a section

  // Timestamps
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([identifier])
  @@index([page])
  @@index([section])
  @@index([published])
}

enum ContentBlockType {
  TEXT // Simple text
  RICH_TEXT // HTML content
  JSON // Complex data structures
  IMAGE // Image URL
  VIDEO // Video URL or embed code
}

// Search Tags for "Obl√≠ben√© vyhled√°v√°n√≠" feature
model SearchTag {
  id          String   @id @default(cuid())
  slug        String   @unique // URL-friendly version
  label       String   // Display name (e.g., "Studentky na sex")
  description String?  // SEO description
  category    String   // age, hair, body, nationality, special
  icon        String?  // Icon name for display
  color       String?  // Gradient color class
  order       Int      @default(0) // Display order within category

  // Relationships
  profiles    ProfileSearchTag[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([category])
  @@index([slug])
}

// Many-to-many relationship between Profile and SearchTag
model ProfileSearchTag {
  id        String   @id @default(cuid())
  profileId String
  tagId     String

  profile   Profile    @relation(fields: [profileId], references: [id], onDelete: Cascade)
  tag       SearchTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([profileId, tagId])
  @@index([profileId])
  @@index([tagId])
}
